<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume Media Player</title>
    <!-- Lume Media Player SVG Favicon (VLC Orange) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23fa7519'/%3E%3Cstop offset='50%25' stop-color='%23e85e00'/%3E%3Cstop offset='100%25' stop-color='%23bd4d00'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='25' fill='url(%23g)'/%3E%3Cpolygon points='35,25 35,75 75,50' fill='%23ffffff'/%3E%3C/svg%3E">
    <!-- PWA Web App Manifest -->
    <link rel="manifest" href="data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Lume%20Media%20Player%22%2C%22short_name%22%3A%22Lume%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%232c2c2c%22%2C%22theme_color%22%3A%22%23e85e00%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20100%20100%27%253E%253Cdefs%253E%253ClinearGradient%20id%3D%27g%27%20x1%3D%270%2525%27%20y1%3D%270%2525%27%20x2%3D%27100%2525%27%20y2%3D%27100%2525%27%253E%253Cstop%20offset%3D%270%2525%27%20stop-color%3D%27%2523fa7519%27%2F%253E%253Cstop%20offset%3D%2750%2525%27%20stop-color%3D%27%2523e85e00%27%2F%253E%253Cstop%20offset%3D%27100%2525%27%20stop-color%3D%27%2523bd4d00%27%2F%253E%253C%2FlinearGradient%253E%253C%2Fdefs%253E%253Crect%20width%3D%27100%27%20height%3D%27100%27%20rx%3D%2725%27%20fill%3D%27url%28%2523g%29%27%2F%253E%253Cpolygon%20points%3D%2735%2C25%2035%2C75%2075%2C50%27%20fill%3D%27%2523ffffff%27%2F%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22192x192%20512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D">
    <style>
        /* CSS Reset & Font */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }
        
        /* Remove default browser focus outlines globally */
        *:focus, *:focus-visible {
            outline: none !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Lucida Grande", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #2c2c2c;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* GTK4 Window Layout Style */
        #app-window {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ececec;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
        }

        /* Main Area (Video + Sidebar) */
        #main-area {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: #000;
        }

        #video-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #000;
            overflow: hidden;
        }

        /* Nested Wrappers for stacking Video Transforms */
        #crop-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #ar-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            background-color: transparent;
            object-fit: contain;
        }

        /* Subtitle Engine Overrides */
        video::-webkit-media-text-track-display,
        ::cue {
            display: none !important; /* Hide native rendering */
            color: transparent;
            background: transparent;
        }

        #custom-subtitles {
            position: absolute;
            bottom: 80px; /* Consistently above bottom controls */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            text-align: center;
            color: #ffffff;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 0px 2px 0 #000, 2px 0px 0 #000, 0px -2px 0 #000, -2px 0px 0 #000;
            font-family: Arial, sans-serif;
            font-size: 28px;
            font-weight: bold;
            pointer-events: none;
            z-index: 40;
        }

        /* Empty State Background (Light Mode Default) */
        #empty-state {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at center, #ffffff 0%, #e0e0e0 100%);
            color: #333;
            z-index: 10;
            text-align: center;
            padding: 20px;
        }

        /* Exciting Lume Animation Keyframes */
        @keyframes pulse-glow {
            0% { transform: scale(1); filter: drop-shadow(0 10px 20px rgba(232, 94, 0, 0.3)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 20px 40px rgba(250, 117, 25, 0.6)); }
            100% { transform: scale(1); filter: drop-shadow(0 10px 20px rgba(232, 94, 0, 0.3)); }
        }

        @keyframes orbit {
            0% { transform: rotate(0deg) translateX(70px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(70px) rotate(-360deg); }
        }

        @keyframes orbit-reverse {
            0% { transform: rotate(360deg) translateX(90px) rotate(-360deg); }
            100% { transform: rotate(0deg) translateX(90px) rotate(0deg); }
        }

        .animated-logo {
            animation: pulse-glow 3s ease-in-out infinite;
            width: 180px;
            height: 180px;
            overflow: visible;
        }

        .orbit-1 {
            transform-origin: 100px 100px;
            animation: orbit 4s linear infinite;
        }

        .orbit-2 {
            transform-origin: 100px 100px;
            animation: orbit-reverse 6s linear infinite;
        }

        #empty-state h2 {
            margin-top: 30px;
            font-weight: 500;
            font-size: 26px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            letter-spacing: 0.5px;
            background: -webkit-linear-gradient(45deg, #fa7519, #bd4d00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #empty-state p {
            margin-top: 10px;
            color: #666;
            font-size: 15px;
        }

        /* OSD (On Screen Display) */
        #osd-text {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 50;
            pointer-events: none;
        }

        /* OS X Mavericks Styled Playlist Sidebar */
        #playlist-sidebar {
            width: 300px;
            background-color: #f1f5f8;
            border-left: 1px solid #b3b3b3;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #playlist-sidebar.collapsed {
            margin-right: -300px;
        }

        .playlist-header {
            background-image: linear-gradient(to bottom, #fdfdfd 0%, #e3e3e3 100%);
            border-bottom: 1px solid #a6a6a6;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            box-shadow: 0 1px 0 rgba(255,255,255,0.5) inset;
        }

        .header-actions {
            display: flex;
            gap: 4px;
        }

        /* Mavericks Buttons */
        .mac-btn {
            background-image: linear-gradient(to bottom, #fdfdfd 0%, #e3e3e3 100%);
            border: 1px solid #a6a6a6;
            border-bottom-color: #979797;
            border-radius: 4px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 1px 1px rgba(0,0,0,0.05);
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            font-size: 13px;
        }

        .mac-btn:active {
            background-image: linear-gradient(to bottom, #d0d0d0 0%, #e1e1e1 100%);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
        }

        .mac-btn svg {
            fill: #444;
            filter: drop-shadow(0 1px 0 rgba(255,255,255,0.8));
        }

        .mac-btn.active-state {
            background-image: linear-gradient(to bottom, #5cb4fc 0%, #0482fc 100%);
            border-color: #0364c6;
            color: white;
            text-shadow: 0 1px 0 rgba(0,0,0,0.4);
            box-shadow: 0 1px 1px rgba(255,255,255,0.3) inset;
        }

        .mac-btn.active-state svg {
            fill: white;
            filter: drop-shadow(0 -1px 0 rgba(0,0,0,0.4));
        }

        #playlist-items {
            list-style: none;
            overflow-y: auto;
            flex: 1;
            background-color: #ffffff;
        }

        /* Drag & Drop Highlight */
        #playlist-sidebar.dragover #playlist-items {
            background-color: #e6f3ff;
            border: 2px dashed #1e90ff;
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            font-size: 12px;
            color: #222;
            border-bottom: 1px solid #eaeaea;
            cursor: pointer;
        }

        .playlist-item-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 8px;
        }

        .playlist-item-controls {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .playlist-item:hover .playlist-item-controls {
            opacity: 1;
        }

        .item-btn {
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px;
            color: #555;
            transition: background 0.1s;
        }

        .item-btn:hover {
            background: #e0e0e0;
        }

        .item-btn svg {
            fill: currentColor;
        }

        .playlist-item:nth-child(even) {
            background-color: #f6f8fa;
        }

        .playlist-item.playing {
            background-color: #3875d7;
            color: white;
            font-weight: bold;
        }
        
        .playlist-item.playing .item-btn {
            color: white;
            border-color: #639bf0;
        }
        
        .playlist-item.playing .item-btn:hover {
            background: #255ebc;
        }

        /* Mavericks Scrollbar */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #f0f0f0; border-left: 1px solid #ddd; }
        ::-webkit-scrollbar-thumb {
            background-color: #c0c0c0;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
        }
        ::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

        /* Bottom Controls Area layout */
        #controls-area {
            background-image: linear-gradient(to bottom, #ededed 0%, #d4d4d4 100%);
            border-top: 1px solid #999;
            display: flex;
            flex-direction: column;
            padding: 8px 12px 12px 12px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset;
            z-index: 100;
        }

        /* Theater Mode & Fullscreen Overrides */
        #app-window.theater-mode #playlist-sidebar,
        #app-window:fullscreen #playlist-sidebar {
            display: none !important;
        }

        #app-window.theater-mode #controls-area,
        #app-window:fullscreen #controls-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-image: linear-gradient(to bottom, rgba(237,237,237,0.95) 0%, rgba(212,212,212,0.95) 100%);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        /* Auto-hide controls */
        #app-window.idle {
            cursor: none;
        }

        #app-window.idle #controls-area {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none;
        }

        /* Timeline Slider */
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .time-display {
            font-size: 11px;
            color: #555;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            font-variant-numeric: tabular-nums;
            width: 40px;
            text-align: center;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }

        /* Mavericks Slider Track */
        input[type=range]::-webkit-slider-runnable-track {
            height: 6px;
            background: #b8b8b8;
            border-radius: 3px;
            border: 1px solid #999;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2) inset, 0 1px 0 rgba(255,255,255,0.8);
        }

        /* Mavericks Slider Thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background-image: linear-gradient(to bottom, #ffffff 0%, #d4d4d4 100%);
            border: 1px solid #888;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            margin-top: -6px;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-group {
            display: flex;
        }
        
        .btn-group .mac-btn {
            border-radius: 0;
            border-right: none;
        }
        
        .btn-group .mac-btn:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        
        .btn-group .mac-btn:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            border-right: 1px solid #a6a6a6;
        }

        #now-playing-text {
            font-size: 12px;
            color: #444;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        #volume-slider {
            width: 80px;
        }

        .hidden { display: none !important; }

        /* Modal Overlays (About & Help) */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: #f1f5f8;
            border: 1px solid #a6a6a6;
            border-radius: 8px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.8) inset;
            padding: 30px;
            width: 380px;
            max-width: 90%;
            text-align: center;
            position: relative;
            color: #333;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #888;
        }

        .modal-close:hover {
            color: #333;
        }

        /* Dark Mode Overrides */
        body.dark-mode #app-window { background-color: #1e1e1e; }
        body.dark-mode #playlist-sidebar { background-color: #2c2c2c; border-left-color: #000; }
        body.dark-mode .playlist-header { 
            background-image: linear-gradient(to bottom, #4a4a4a 0%, #2b2b2b 100%);
            border-bottom-color: #000;
            color: #ddd;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.8);
            box-shadow: 0 1px 0 rgba(255,255,255,0.1) inset;
        }
        body.dark-mode .mac-btn {
            background-image: linear-gradient(to bottom, #555 0%, #333 100%);
            border-color: #111;
            box-shadow: 0 1px 0 rgba(255,255,255,0.1) inset, 0 1px 1px rgba(0,0,0,0.3);
            color: #eee;
        }
        body.dark-mode .mac-btn:active {
            background-image: linear-gradient(to bottom, #222 0%, #333 100%);
        }
        body.dark-mode .mac-btn svg {
            fill: #eee;
            filter: drop-shadow(0 -1px 0 rgba(0,0,0,0.8));
        }
        body.dark-mode .mac-btn.active-state {
            background-image: linear-gradient(to bottom, #1a5c9a 0%, #033a76 100%);
            border-color: #01162d;
            color: white;
            text-shadow: 0 1px 0 rgba(0,0,0,0.4);
            box-shadow: 0 1px 1px rgba(255,255,255,0.3) inset;
        }
        body.dark-mode .mac-btn.active-state svg {
            fill: white;
            filter: drop-shadow(0 -1px 0 rgba(0,0,0,0.4));
        }
        body.dark-mode #playlist-items { background-color: #1e1e1e; }
        body.dark-mode .playlist-item { color: #ccc; border-bottom-color: #333; }
        body.dark-mode .playlist-item:nth-child(even) { background-color: #252525; }
        body.dark-mode .playlist-item.playing { background-color: #1a5c9a; color: white; }
        
        body.dark-mode .item-btn { border-color: #555; color: #ccc; }
        body.dark-mode .item-btn:hover { background: #444; }
        
        body.dark-mode #controls-area {
            background-image: linear-gradient(to bottom, #444 0%, #222 100%);
            border-top-color: #000;
            box-shadow: 0 1px 0 rgba(255,255,255,0.1) inset;
        }
        body.dark-mode #app-window.theater-mode #controls-area,
        body.dark-mode #app-window:fullscreen #controls-area {
            background-image: linear-gradient(to bottom, rgba(68,68,68,0.95) 0%, rgba(34,34,34,0.95) 100%);
        }
        body.dark-mode .time-display { color: #bbb; text-shadow: 0 -1px 0 rgba(0,0,0,0.8); }
        body.dark-mode #now-playing-text { color: #ddd; text-shadow: 0 -1px 0 rgba(0,0,0,0.8); }
        body.dark-mode input[type=range]::-webkit-slider-runnable-track {
            background: #333;
            border-color: #111;
            box-shadow: 0 1px 1px rgba(0,0,0,0.5) inset, 0 1px 0 rgba(255,255,255,0.1);
        }
        body.dark-mode input[type=range]::-webkit-slider-thumb {
            background-image: linear-gradient(to bottom, #666 0%, #333 100%);
            border-color: #111;
        }
        
        /* Dark Mode overrides for Empty State & Modals */
        body.dark-mode #empty-state {
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            color: #eee;
        }
        body.dark-mode #empty-state p { color: #aaa; }
        body.dark-mode #empty-state h2 { text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        body.dark-mode .modal-content {
            background-color: #2c2c2c;
            border-color: #000;
            color: #eee;
        }
        body.dark-mode .modal-close:hover { color: #fff; }
    </style>
</head>
<body>

<div id="app-window">
    <!-- Modals -->
    <div id="about-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close" id="btn-close-about">&times;</button>
            <svg class="animated-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" style="width: 120px; height: 120px; margin: 0 auto;">
                <!-- Orbiting Particles -->
                <circle class="orbit-1" cx="100" cy="100" r="12" fill="url(#ringGrad)" />
                <circle class="orbit-2" cx="100" cy="100" r="7" fill="url(#orbitGrad)" />
                <!-- Main Icon Body -->
                <rect x="50" y="50" width="100" height="100" rx="25" fill="url(#lumeGrad)" />
                <!-- Play Button Polygon -->
                <polygon points="85,75 85,125 125,100" fill="#ffffff" />
            </svg>
            <h2 style="margin-top: 15px; font-weight: bold; font-size: 22px; background: -webkit-linear-gradient(45deg, #fa7519, #bd4d00); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Lume Media Player</h2>
            <p style="margin-top: 10px; font-weight: bold; font-size: 14px;">Created by: Tekken (Hammad Ahmed)</p>
            <p style="margin-top: 10px; font-size: 13px; color: inherit; opacity: 0.8; line-height: 1.5;">Version 1.0<br>A modern, web-based local HTML5 media player providing an advanced cinematic playback experience.</p>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay hidden">
        <div class="modal-content" style="text-align: left;">
            <button class="modal-close" id="btn-close-help">&times;</button>
            <h2 style="margin-bottom: 15px; font-size: 20px; text-align: center;">Keyboard Shortcuts</h2>
            <ul style="list-style: none; font-size: 13px; line-height: 2; padding: 0;">
                <li><strong>Space:</strong> Play / Pause</li>
                <li><strong>F / Double Click:</strong> Toggle Fullscreen</li>
                <li><strong>T:</strong> Toggle Theater Mode</li>
                <li><strong>Z:</strong> Cycle Zoom Modes (Fit, Fill, Original)</li>
                <li><strong>Alt + / Alt -:</strong> Custom Zoom In / Out</li>
                <li><strong>A / C:</strong> Toggle Aspect Ratio / Crop</li>
                <li><strong>M:</strong> Toggle Mute</li>
                <li><strong>[ / ]:</strong> Decrease / Increase Speed</li>
                <li><strong>Arrow Left/Right:</strong> Seek &plusmn;10s</li>
                <li><strong>Ctrl + Arrow Left/Right:</strong> Prev/Next Subtitle</li>
                <li><strong>Arrow Up/Down:</strong> Adjust Volume</li>
            </ul>
        </div>
    </div>

    <div id="main-area">
        <div id="video-container" title="Double click to toggle fullscreen">
            <!-- Animated SVG Empty State Overlay (Lume Media Player) -->
            <div id="empty-state">
                <svg class="animated-logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="lumeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#fa7519" />
                            <stop offset="50%" stop-color="#e85e00" />
                            <stop offset="100%" stop-color="#bd4d00" />
                        </linearGradient>
                        <linearGradient id="ringGrad" x1="100%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#ffffff" />
                            <stop offset="100%" stop-color="#e0e0e0" />
                        </linearGradient>
                        <linearGradient id="orbitGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#bd4d00" />
                            <stop offset="100%" stop-color="#fa7519" />
                        </linearGradient>
                    </defs>
                    
                    <!-- Orbiting Particles -->
                    <circle class="orbit-1" cx="100" cy="100" r="12" fill="url(#ringGrad)" />
                    <circle class="orbit-2" cx="100" cy="100" r="7" fill="url(#orbitGrad)" />
                    
                    <!-- Main Icon Body -->
                    <rect x="50" y="50" width="100" height="100" rx="25" fill="url(#lumeGrad)" />
                    <!-- Play Button Polygon -->
                    <polygon points="85,75 85,125 125,100" fill="#ffffff" />
                </svg>
                <h2>No Media Loaded</h2>
                <p>Drag & Drop files or folders into the Playlist to add media.</p>
            </div>
            
            <div id="crop-wrapper">
                <div id="ar-wrapper">
                    <video id="player" playsinline></video>
                </div>
            </div>
            <!-- Custom subtitle overlay decoupled from video transformations -->
            <div id="custom-subtitles"></div>
            <div id="osd-text"></div>
        </div>
        
        <div id="playlist-sidebar">
            <div class="playlist-header">
                <span>Playlist</span>
                <div class="header-actions">
                    <button class="mac-btn" id="add-folder-btn" title="Add Folder" style="padding: 4px 6px;">
                        <svg width="12" height="12" viewBox="0 0 16 16"><path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h3.88a1.5 1.5 0 0 1 1.06.44L8.5 3.5h5A1.5 1.5 0 0 1 15 5v7.5a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 12.5v-9z"/></svg>
                    </button>
                    <button class="mac-btn" id="add-media-btn" title="Add Media Files" style="padding: 4px 6px;">
                        <svg width="12" height="12" viewBox="0 0 16 16"><path d="M7 7V2h2v5h5v2H9v5H7V9H2V7h5z"/></svg>
                    </button>
                    <button class="mac-btn" id="clear-playlist-btn" title="Clear Playlist" style="padding: 4px 6px;">
                        <svg width="12" height="12" viewBox="0 0 16 16"><path d="M5.5 1a.5.5 0 0 0-.5.5v1h6v-1a.5.5 0 0 0-.5-.5h-5zM2 3v1h12V3H2zm1 2v8.5A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5V5H3z"/></svg>
                    </button>
                </div>
                <!-- Hidden inputs -->
                <input type="file" id="file-input" multiple accept="audio/*,video/*,.srt,.vtt" class="hidden">
                <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden">
            </div>
            <ul id="playlist-items">
                <li style="padding: 20px; text-align: center; color: #888; font-style: italic;">
                    Drag & Drop files or folders here to add.
                </li>
            </ul>
        </div>
    </div>

    <div id="controls-area">
        <div class="slider-container">
            <span class="time-display" id="current-time">00:00</span>
            <input type="range" id="timeline" value="0" min="0" step="0.1">
            <span class="time-display" id="total-time">00:00</span>
        </div>
        
        <div class="controls-row">
            <!-- Left Controls: Playback & View -->
            <div class="control-group">
                <div class="btn-group">
                    <button class="mac-btn" id="btn-play" title="Play/Pause (Space)">
                        <svg width="14" height="14" viewBox="0 0 16 16" id="icon-play"><path d="M4 2l10 6-10 6V2z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-prev" title="Previous (P)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M4 2v12h2V9l7 5V2l-7 5V2H4z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-stop" title="Stop (S)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M3 3h10v10H3V3z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-next" title="Next (N)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M12 2v12h-2V9l-7 5V2l7 5V2h2z"/></svg>
                    </button>
                </div>
                
                <div class="btn-group" style="margin-left: 8px;">
                    <button class="mac-btn" id="btn-theater" title="Theater Mode (T)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M1 3h14v10H1V3zm2 2v6h10V5H3z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-fullscreen" title="Fullscreen (F)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M2 2v4h2V4h2V2H2zm10 0v2h2v2h2V2h-4zM2 14h4v-2H4v-2H2v4zm10 0h4v-4h-2v2h-2v2z"/></svg>
                    </button>
                </div>
            </div>

            <!-- Center Controls: Now Playing -->
            <div class="control-group" style="flex: 1; justify-content: center;">
                <div id="now-playing-text">Lume Media Player</div>
            </div>

            <!-- Right Controls: Subtitles/Tracks, Playlist, Actions, Vol -->
            <div class="control-group">
                <button class="mac-btn" id="btn-dark-mode" title="Toggle Dark Mode" style="margin-right: 8px;">
                    <svg width="14" height="14" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>
                </button>
                
                <input type="file" id="subtitle-input" accept=".srt,.vtt" class="hidden">
                <div class="btn-group">
                    <button class="mac-btn" id="btn-load-subtitle" title="Load Subtitle File">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M2 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H2zm2.5 4.5H3v1h1.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5h2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5zm5 0H8v1h1.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H7a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5h2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-sub-track" title="Cycle Subtitle Track">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M3 4h10a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1zm1 2v4h2V6H4v2zm4 0v4h2V6H8v2z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-audio-track" title="Cycle Audio Track">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M11.5 2v7.5a2.5 2.5 0 1 1-1-2.3v-4.2H14V2h-2.5z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-playlist" title="Toggle Playlist">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M2 4h12v2H2V4zm0 4h12v2H2V8zm0 4h8v2H2v-2z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-loop" title="Loop">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M13 4v3h-2V5H5v2L2 4.5 5 2v2h8zM3 12v-3h2v2h8v-2l3 2.5-3 2.5v-2H3z"/></svg>
                    </button>
                </div>
                
                <button class="mac-btn" id="btn-mute" title="Mute (M)" style="margin-left: 8px;">
                    <svg width="14" height="14" viewBox="0 0 16 16" id="icon-vol"><path d="M2 6v4h3l4 4V2L5 6H2zm10-1.5v7c1.3-.7 2-2 2-3.5s-.7-2.8-2-3.5z"/></svg>
                </button>
                <input type="range" id="volume-slider" value="1" min="0" max="1" step="0.05" title="Volume (Up/Down)">

                <!-- PWA Install Button -->
                <button class="mac-btn hidden" id="btn-install" title="Install App" style="margin-left: 8px;">
                    <svg width="14" height="14" viewBox="0 0 16 16"><path d="M8 12l-3-3h2V1h2v8h2L8 12zM2 14v-2H1v3h14v-3h-1v2H2z"/></svg>
                </button>

                <div class="btn-group" style="margin-left: 8px;">
                    <button class="mac-btn" id="btn-about" title="About">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0-1A6 6 0 1 0 8 2a6 6 0 0 0 0 12zM7 7h2v5H7V7zm1-3a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-help" title="Help">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0-1A6 6 0 1 0 8 2a6 6 0 0 0 0 12zM7 4h2a2 2 0 0 1 2 2c0 1.5-2 2-2 3v1H7V8.5c0-1.5 2-2 2-2.5a1 1 0 0 0-2 0H5a3 3 0 0 1 3-3zm1 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- State ---
    let playlist = []; // Array of { file: File, objectUrl: String|null, subtitleUrl: String|null, pendingSubFile: File|null }
    let currentIndex = -1;
    let isLooping = false;
    let idleTimer;
    let osdTimer;

    // Aspect Ratios, Crop & Zoom Configuration
    const aspectRatios = ['Default', '16:9', '4:3', '1:1', '16:10', '2.21:1', '2.35:1', '2.39:1', '5:4'];
    let currentArIndex = 0;
    let currentCropIndex = 0;

    const zoomModes = ['Fit Screen', 'Fill Screen', 'Original Size'];
    let currentZoomIndex = 0;
    let customZoom = null; // Percentage zoom state (overrides preset modes)
    let currentSubtitleText = ''; // Memory for subtitle rendering

    // --- DOM Elements ---
    const appWindow = document.getElementById('app-window');
    const player = document.getElementById('player');
    const cropWrapper = document.getElementById('crop-wrapper');
    const arWrapper = document.getElementById('ar-wrapper');
    const customSubtitles = document.getElementById('custom-subtitles');
    const videoContainer = document.getElementById('video-container');
    const controlsArea = document.getElementById('controls-area');
    const osdText = document.getElementById('osd-text');
    const emptyState = document.getElementById('empty-state');
    const fileInput = document.getElementById('file-input');
    const folderInput = document.getElementById('folder-input');
    const subtitleInput = document.getElementById('subtitle-input');
    const playlistItemsContainer = document.getElementById('playlist-items');
    const playlistSidebar = document.getElementById('playlist-sidebar');
    const timeline = document.getElementById('timeline');
    const volumeSlider = document.getElementById('volume-slider');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');
    const nowPlayingText = document.getElementById('now-playing-text');
    
    // Buttons
    const btnPlay = document.getElementById('btn-play');
    const btnPrev = document.getElementById('btn-prev');
    const btnStop = document.getElementById('btn-stop');
    const btnNext = document.getElementById('btn-next');
    const btnFullscreen = document.getElementById('btn-fullscreen');
    const btnTheater = document.getElementById('btn-theater');
    const btnPlaylist = document.getElementById('btn-playlist');
    const btnLoadSubtitle = document.getElementById('btn-load-subtitle');
    const btnSubTrack = document.getElementById('btn-sub-track');
    const btnAudioTrack = document.getElementById('btn-audio-track');
    const btnDarkMode = document.getElementById('btn-dark-mode');
    const btnLoop = document.getElementById('btn-loop');
    const btnMute = document.getElementById('btn-mute');
    const btnAddMedia = document.getElementById('add-media-btn');
    const btnAddFolder = document.getElementById('add-folder-btn');
    const btnClearPlaylist = document.getElementById('clear-playlist-btn');
    const btnInstall = document.getElementById('btn-install');
    const btnAbout = document.getElementById('btn-about');
    const btnHelp = document.getElementById('btn-help');

    // Modals
    const aboutModal = document.getElementById('about-modal');
    const helpModal = document.getElementById('help-modal');
    const btnCloseAbout = document.getElementById('btn-close-about');
    const btnCloseHelp = document.getElementById('btn-close-help');

    // SVGs for toggles and icons
    const iconPlay = `<path d="M4 2l10 6-10 6V2z"/>`;
    const iconPause = `<path d="M4 2h3v12H4V2zm5 0h3v12H9V2z"/>`;
    const iconVolOn = `<path d="M2 6v4h3l4 4V2L5 6H2zm10-1.5v7c1.3-.7 2-2 2-3.5s-.7-2.8-2-3.5z"/>`;
    const iconVolOff = `<path d="M2 6v4h3l4 4V2L5 6H2zm9 0l3 3m0-3l-3 3"/>`;
    const iconUp = `<svg width="10" height="10" viewBox="0 0 16 16"><path d="M8 2l-6 6h4v6h4V8h4z"/></svg>`;
    const iconDown = `<svg width="10" height="10" viewBox="0 0 16 16"><path d="M8 14l6-6h-4V2H6v6H2z"/></svg>`;
    const iconRemove = `<svg width="10" height="10" viewBox="0 0 16 16"><path d="M14 3.4L12.6 2 8 6.6 3.4 2 2 3.4 6.6 8 2 12.6 3.4 14 8 9.4 12.6 14 14 12.6 9.4 8z"/></svg>`;

    // --- Core Functions ---

    function formatTime(seconds) {
        if (isNaN(seconds)) return "00:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function showOSD(text) {
        osdText.textContent = text;
        osdText.style.opacity = 1;
        clearTimeout(osdTimer);
        osdTimer = setTimeout(() => osdText.style.opacity = 0, 2000);
    }

    // --- Playlist Management ---

    function updatePlaylistUI() {
        if (playlist.length === 0) {
            playlistItemsContainer.innerHTML = '<li style="padding: 20px; text-align: center; color: #888; font-style: italic;">Drag & Drop files or folders here to add.</li>';
            return;
        }

        playlistItemsContainer.innerHTML = '';
        playlist.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = `playlist-item ${index === currentIndex ? 'playing' : ''}`;
            li.ondblclick = () => playItem(index);

            const titleSpan = document.createElement('div');
            titleSpan.className = 'playlist-item-title';
            titleSpan.textContent = item.file.name;
            titleSpan.title = item.file.name;

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'playlist-item-controls';

            const btnUp = document.createElement('button');
            btnUp.className = 'item-btn';
            btnUp.title = "Move Up";
            btnUp.innerHTML = iconUp;
            btnUp.onclick = (e) => { e.stopPropagation(); moveItem(index, -1); };

            const btnDown = document.createElement('button');
            btnDown.className = 'item-btn';
            btnDown.title = "Move Down";
            btnDown.innerHTML = iconDown;
            btnDown.onclick = (e) => { e.stopPropagation(); moveItem(index, 1); };

            const btnRemove = document.createElement('button');
            btnRemove.className = 'item-btn';
            btnRemove.title = "Remove";
            btnRemove.innerHTML = iconRemove;
            btnRemove.onclick = (e) => { e.stopPropagation(); removeItem(index); };

            controlsDiv.append(btnUp, btnDown, btnRemove);
            li.append(titleSpan, controlsDiv);
            playlistItemsContainer.appendChild(li);
        });
    }

    function loadFiles(fileList) {
        let newMedia = [];
        let newSubs = [];

        // Separate Media vs Subtitle files
        for (let i = 0; i < fileList.length; i++) {
            const file = fileList[i];
            const nameLower = file.name.toLowerCase();
            if (file.type.startsWith('video/') || file.type.startsWith('audio/') || 
                nameLower.endsWith('.mkv') || nameLower.endsWith('.mp4') || nameLower.endsWith('.webm') || nameLower.endsWith('.mp3')) {
                newMedia.push(file);
            } else if (nameLower.endsWith('.srt') || nameLower.endsWith('.vtt')) {
                newSubs.push(file);
            }
        }

        // Add media and auto-match subtitles based on identical base filename
        newMedia.forEach(mediaFile => {
            const baseName = mediaFile.name.substring(0, mediaFile.name.lastIndexOf('.')) || mediaFile.name;
            
            const matchedSub = newSubs.find(sub => {
                const subBaseName = sub.name.substring(0, sub.name.lastIndexOf('.')) || sub.name;
                return subBaseName === baseName;
            });

            playlist.push({
                file: mediaFile,
                objectUrl: null,
                subtitleUrl: null,
                pendingSubFile: matchedSub || null
            });
        });

        updatePlaylistUI();
        if (currentIndex === -1 && playlist.length > 0) {
            playItem(0);
        }
    }

    function clearPlaylist() {
        playlist.forEach(item => {
            if (item.objectUrl) URL.revokeObjectURL(item.objectUrl);
            if (item.subtitleUrl) URL.revokeObjectURL(item.subtitleUrl);
        });
        playlist = [];
        currentIndex = -1;
        player.src = "";
        
        let oldTrack = player.querySelector('track');
        if (oldTrack) oldTrack.remove();
        
        customSubtitles.innerHTML = '';
        currentSubtitleText = '';
        nowPlayingText.textContent = "Lume Media Player";
        document.title = "Lume Media Player";
        emptyState.style.display = 'flex';
        
        stop();
        updatePlaylistUI();
    }

    function moveItem(index, direction) {
        if (direction === -1 && index === 0) return;
        if (direction === 1 && index === playlist.length - 1) return;

        const targetIndex = index + direction;
        
        // Swap array elements
        const temp = playlist[index];
        playlist[index] = playlist[targetIndex];
        playlist[targetIndex] = temp;

        // Keep currentIndex tracking the actively playing item
        if (currentIndex === index) {
            currentIndex = targetIndex;
        } else if (currentIndex === targetIndex) {
            currentIndex = index;
        }

        updatePlaylistUI();
    }

    function removeItem(index) {
        const item = playlist[index];
        
        // Memory cleanup
        if (item.objectUrl) URL.revokeObjectURL(item.objectUrl);
        if (item.subtitleUrl) URL.revokeObjectURL(item.subtitleUrl);

        playlist.splice(index, 1);

        if (playlist.length === 0) {
            clearPlaylist();
        } else if (currentIndex === index) {
            // We removed the item currently playing
            currentIndex = -1; 
            let nextToPlay = index >= playlist.length ? playlist.length - 1 : index;
            playItem(nextToPlay);
        } else if (currentIndex > index) {
            // Shift index back to maintain correct tracking if an earlier item is removed
            currentIndex--;
            updatePlaylistUI();
        } else {
            updatePlaylistUI();
        }
    }

    // --- Subtitle Parser ---
    function srtToVtt(srtContent) {
        let vtt = 'WEBVTT\n\n';
        vtt += srtContent.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
        return vtt;
    }

    function injectSubtitle(item, content, isSrt) {
        if (isSrt) content = srtToVtt(content);
        
        if (item.subtitleUrl) URL.revokeObjectURL(item.subtitleUrl);
        const blob = new Blob([content], { type: 'text/vtt' });
        item.subtitleUrl = URL.createObjectURL(blob);

        let oldTrack = player.querySelector('track');
        if (oldTrack) oldTrack.remove();

        const track = document.createElement('track');
        track.kind = 'subtitles';
        track.label = 'Custom Subtitles';
        track.srclang = 'en';
        track.src = item.subtitleUrl;
        track.default = true;
        player.appendChild(track);

        if (player.textTracks && player.textTracks.length > 0) {
            player.textTracks[0].mode = 'hidden'; // Hide native, let our overlay handle it
        }
    }

    function playItem(index) {
        if (index < 0 || index >= playlist.length) return;
        
        const item = playlist[index];

        if (!item.objectUrl) {
            item.objectUrl = URL.createObjectURL(item.file);
        }
        player.src = item.objectUrl;

        // Reset old tracks
        let oldTrack = player.querySelector('track');
        if (oldTrack) oldTrack.remove();
        customSubtitles.innerHTML = '';
        currentSubtitleText = '';

        // Handle auto-loaded / specific subtitles
        if (item.pendingSubFile && !item.subtitleUrl) {
            const reader = new FileReader();
            reader.onload = (e) => {
                injectSubtitle(item, e.target.result, item.pendingSubFile.name.toLowerCase().endsWith('.srt'));
                showOSD("Auto-loaded Subtitle");
            };
            reader.readAsText(item.pendingSubFile);
        } else if (item.subtitleUrl) {
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = 'Custom Subtitles';
            track.srclang = 'en';
            track.src = item.subtitleUrl;
            track.default = true;
            player.appendChild(track);
            if (player.textTracks && player.textTracks.length > 0) {
                player.textTracks[0].mode = 'hidden';
            }
        }

        currentIndex = index;
        
        // Hide empty state background
        emptyState.style.display = 'none';

        // Update UI Text & Page Title dynamically
        nowPlayingText.textContent = item.file.name;
        document.title = `${item.file.name} - Lume Media Player`;
        
        updatePlaylistUI();
        
        // Reset transforms
        currentArIndex = 0;
        currentCropIndex = 0;
        currentZoomIndex = 0;
        customZoom = null;
        applyVideoTransforms('default');

        player.play().catch(e => console.log("Playback prevented:", e));
    }

    function togglePlay() {
        if (playlist.length === 0) return;
        if (player.paused) {
            player.play();
            showOSD("Play");
        } else {
            player.pause();
            showOSD("Pause");
        }
    }

    function stop() {
        player.pause();
        player.currentTime = 0;
        btnPlay.querySelector('svg').innerHTML = iconPlay;
        customSubtitles.innerHTML = '';
        currentSubtitleText = '';
        showOSD("Stopped");
    }

    function playNext() {
        if (playlist.length === 0) return;
        let nextIdx = currentIndex + 1;
        if (nextIdx >= playlist.length) {
            nextIdx = isLooping ? 0 : playlist.length - 1;
            if (!isLooping) { stop(); return; }
        }
        playItem(nextIdx);
    }

    function playPrev() {
        if (playlist.length === 0) return;
        let prevIdx = currentIndex - 1;
        if (prevIdx < 0) prevIdx = isLooping ? playlist.length - 1 : 0;
        playItem(prevIdx);
    }

    function toggleMute() {
        player.muted = !player.muted;
        updateVolumeUI();
        showOSD(player.muted ? "Muted" : "Unmuted");
    }

    function updateVolumeUI() {
        if (player.muted || player.volume === 0) {
            btnMute.querySelector('svg').innerHTML = iconVolOff;
        } else {
            btnMute.querySelector('svg').innerHTML = iconVolOn;
        }
        volumeSlider.value = player.muted ? 0 : player.volume;
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            appWindow.requestFullscreen().catch(err => console.log(err));
        } else {
            document.exitFullscreen();
        }
    }

    function toggleTheaterMode() {
        if (document.fullscreenElement) return; // Ignore if already fullscreen
        appWindow.classList.toggle('theater-mode');
        btnTheater.classList.toggle('active-state');
        showOSD(appWindow.classList.contains('theater-mode') ? "Theater Mode On" : "Theater Mode Off");
    }

    // --- Aspect Ratio, Crop & Zoom Engine ---
    
    function applyVideoTransforms(triggerSource) {
        const ar = aspectRatios[currentArIndex];
        const crop = aspectRatios[currentCropIndex];
        const zoomMode = zoomModes[currentZoomIndex];

        // 1. Setup Outer Crop Wrapper (The window masking box)
        if (crop === 'Default') {
            cropWrapper.style.aspectRatio = 'auto';
            cropWrapper.style.maxWidth = '100%';
            cropWrapper.style.maxHeight = '100%';
        } else {
            const [cw, ch] = crop.split(':');
            cropWrapper.style.aspectRatio = `${cw}/${ch}`;
            cropWrapper.style.maxWidth = `calc(100vh * (${cw} / ${ch}))`;
            cropWrapper.style.maxHeight = `calc(100vw * (${ch} / ${cw}))`;
        }

        // 2. Setup Inner Aspect Ratio Wrapper (Stretches the video container)
        if (ar === 'Default') {
            arWrapper.style.aspectRatio = 'auto';
            arWrapper.style.minWidth = '0';
            arWrapper.style.minHeight = '0';
            arWrapper.style.width = '100%';
            arWrapper.style.height = '100%';
            player.style.objectFit = (crop === 'Default') ? 'contain' : 'cover';
        } else {
            const [aw, ah] = ar.split(':');
            arWrapper.style.aspectRatio = `${aw}/${ah}`;
            player.style.objectFit = 'fill';
            
            if (crop !== 'Default') {
                // Video AR container must cover the crop mask box
                arWrapper.style.minWidth = '100%';
                arWrapper.style.minHeight = '100%';
                arWrapper.style.width = 'auto';
                arWrapper.style.height = 'auto';
            } else {
                // Video AR container naturally constraints inside full viewport
                arWrapper.style.maxWidth = `calc(100vh * (${aw} / ${ah}))`;
                arWrapper.style.maxHeight = `calc(100vw * (${ah} / ${aw}))`;
                arWrapper.style.minWidth = '0';
                arWrapper.style.minHeight = '0';
                arWrapper.style.width = '100%';
                arWrapper.style.height = '100%';
            }
        }

        // 3. Setup Zoom (Scale transformation exclusively on the outer wrapper)
        let scale = 1;
        if (customZoom !== null) {
            scale = customZoom;
        } else {
            if (zoomMode === 'Fit Screen') {
                scale = 1;
            } else if (zoomMode === 'Fill Screen') {
                // Dynamically calculates scale required to fully fill screen bounds
                const cw = cropWrapper.offsetWidth || videoContainer.offsetWidth;
                const ch = cropWrapper.offsetHeight || videoContainer.offsetHeight;
                if (cw > 0 && ch > 0) {
                    const scaleX = videoContainer.offsetWidth / cw;
                    const scaleY = videoContainer.offsetHeight / ch;
                    scale = Math.max(scaleX, scaleY);
                }
            } else if (zoomMode === 'Original Size') {
                const vw = player.videoWidth;
                const cw = cropWrapper.offsetWidth;
                if (vw && cw) {
                    scale = vw / cw;
                }
            }
        }

        cropWrapper.style.transform = `scale(${scale})`;

        // OSD Notifications
        if (triggerSource === 'aspect') showOSD(`Aspect Ratio: ${ar}`);
        else if (triggerSource === 'crop') showOSD(`Crop: ${crop}`);
        else if (triggerSource === 'zoom') {
            if (customZoom !== null) showOSD(`Zoom: ${Math.round(customZoom * 100)}%`);
            else showOSD(`Zoom: ${zoomMode}`);
        }
    }

    function toggleAspectRatio() {
        currentArIndex = (currentArIndex + 1) % aspectRatios.length;
        applyVideoTransforms('aspect');
    }

    function toggleCrop() {
        currentCropIndex = (currentCropIndex + 1) % aspectRatios.length;
        applyVideoTransforms('crop');
    }

    function toggleZoom() {
        customZoom = null; // Clear manual percentage zoom to restore preset cycling behavior
        currentZoomIndex = (currentZoomIndex + 1) % zoomModes.length;
        applyVideoTransforms('zoom');
    }

    // --- Subtitle Load from Button ---
    subtitleInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file || currentIndex === -1) {
            if (currentIndex === -1) showOSD("Load a media file first");
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const item = playlist[currentIndex];
            injectSubtitle(item, e.target.result, file.name.toLowerCase().endsWith('.srt'));
            showOSD("Subtitle Loaded");
            subtitleInput.value = '';
        };
        reader.readAsText(file);
    });

    // --- Track Controls ---
    btnSubTrack.addEventListener('click', () => {
        const tracks = player.textTracks;
        if (!tracks || tracks.length === 0) {
            showOSD("No Subtitles Available");
            return;
        }

        let currentlyActiveIndex = -1;
        for (let i = 0; i < tracks.length; i++) {
            if (tracks[i].mode === 'hidden' || tracks[i].mode === 'showing') {
                currentlyActiveIndex = i;
                tracks[i].mode = 'disabled';
                break;
            }
        }

        let nextIndex = currentlyActiveIndex + 1;
        if (nextIndex >= tracks.length) {
            showOSD("Subtitles Disabled");
            customSubtitles.innerHTML = '';
            currentSubtitleText = '';
        } else {
            tracks[nextIndex].mode = 'hidden'; // Route to custom engine
            showOSD(`Subtitle Track: ${tracks[nextIndex].label || (nextIndex + 1)}`);
        }
    });

    btnAudioTrack.addEventListener('click', () => {
        const tracks = player.audioTracks;
        if (!tracks) {
            showOSD("Audio Tracks API unsupported by this Browser/Format");
            return;
        }
        if (tracks.length <= 1) {
            showOSD("No Alternate Audio Tracks found");
            return;
        }

        let currentlyEnabledIndex = 0;
        for (let i = 0; i < tracks.length; i++) {
            if (tracks[i].enabled) {
                currentlyEnabledIndex = i;
                break;
            }
        }

        let nextIndex = (currentlyEnabledIndex + 1) % tracks.length;
        
        // Standard Web API dictates we should enable target track to cleanly flip audio 
        for (let i = 0; i < tracks.length; i++) {
            tracks[i].enabled = (i === nextIndex);
        }
        
        showOSD(`Audio Track: ${tracks[nextIndex].label || (nextIndex + 1)}`);
    });

    function navigateSubtitles(direction) {
        const tracks = player.textTracks;
        if (!tracks || tracks.length === 0) return;
        
        let track = null;
        for (let i = 0; i < tracks.length; i++) {
            if (tracks[i].mode === 'hidden' || tracks[i].mode === 'showing') {
                track = tracks[i];
                break;
            }
        }

        if (!track || !track.cues || track.cues.length === 0) {
            showOSD("No Subtitles Loaded");
            return;
        }

        const currentTime = player.currentTime;
        let targetTime = -1;

        if (direction === 'next') {
            for (let i = 0; i < track.cues.length; i++) {
                if (track.cues[i].startTime > currentTime + 0.1) {
                    targetTime = track.cues[i].startTime;
                    break;
                }
            }
        } else if (direction === 'prev') {
            for (let i = track.cues.length - 1; i >= 0; i--) {
                if (track.cues[i].startTime < currentTime - 0.5) { // Small buffer for double-tapping prev
                    targetTime = track.cues[i].startTime;
                    break;
                }
            }
        }

        if (targetTime !== -1) {
            player.currentTime = targetTime;
            showOSD(direction === 'next' ? 'Next Subtitle' : 'Prev Subtitle');
        }
    }

    function changePlaybackSpeed(delta) {
        player.playbackRate = Math.max(0.25, Math.min(4.0, player.playbackRate + delta));
        showOSD(`Speed: ${player.playbackRate.toFixed(2)}x`);
    }

    // --- Idle Cursor / Controls Management ---
    function resetIdleTimer() {
        appWindow.classList.remove('idle');
        clearTimeout(idleTimer);

        if (document.fullscreenElement || appWindow.classList.contains('theater-mode')) {
            idleTimer = setTimeout(() => {
                appWindow.classList.add('idle');
            }, 2000); // 2 seconds idle timeout
        }
    }

    controlsArea.addEventListener('mouseenter', () => {
        clearTimeout(idleTimer);
        appWindow.classList.remove('idle');
    });
    
    controlsArea.addEventListener('mouseleave', resetIdleTimer);
    window.addEventListener('mousemove', resetIdleTimer);

    // Fullscreen change handler
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            btnFullscreen.classList.add('active-state');
            appWindow.classList.remove('theater-mode');
            btnTheater.classList.remove('active-state');
        } else {
            btnFullscreen.classList.remove('active-state');
            appWindow.classList.remove('idle');
        }
        applyVideoTransforms('zoom');
        resetIdleTimer();
    });

    // Window resize handler for bounds recalculation
    window.addEventListener('resize', () => {
        if (currentArIndex > 0 || currentCropIndex > 0 || currentZoomIndex > 0 || customZoom !== null) {
            applyVideoTransforms();
        }
    });

    // --- Event Listeners ---

    // File Inputs
    btnAddMedia.onclick = () => fileInput.click();
    fileInput.onchange = (e) => loadFiles(e.target.files);
    
    btnAddFolder.onclick = () => folderInput.click();
    folderInput.onchange = (e) => loadFiles(e.target.files);

    btnClearPlaylist.onclick = () => clearPlaylist();

    btnLoadSubtitle.onclick = () => subtitleInput.click();

    // Drag and Drop
    playlistSidebar.addEventListener('dragover', (e) => {
        e.preventDefault();
        playlistSidebar.classList.add('dragover');
    });
    playlistSidebar.addEventListener('dragleave', () => {
        playlistSidebar.classList.remove('dragover');
    });
    playlistSidebar.addEventListener('drop', (e) => {
        e.preventDefault();
        playlistSidebar.classList.remove('dragover');
        
        let droppedFiles = [];
        if (e.dataTransfer.items) {
            for (let i = 0; i < e.dataTransfer.items.length; i++) {
                if (e.dataTransfer.items[i].kind === 'file') {
                    droppedFiles.push(e.dataTransfer.items[i].getAsFile());
                }
            }
        } else {
            droppedFiles = Array.from(e.dataTransfer.files);
        }
        
        if (droppedFiles.length > 0) {
            loadFiles(droppedFiles);
        }
    });

    // Player events
    player.addEventListener('play', () => btnPlay.querySelector('svg').innerHTML = iconPause);
    player.addEventListener('pause', () => btnPlay.querySelector('svg').innerHTML = iconPlay);
    player.addEventListener('timeupdate', () => {
        if (!timeline.getAttribute('data-seeking')) {
            timeline.value = player.currentTime;
        }
        currentTimeDisplay.textContent = formatTime(player.currentTime);

        // Custom Subtitle Overlay Execution
        let activeTrack = null;
        if (player.textTracks) {
            for (let i = 0; i < player.textTracks.length; i++) {
                if (player.textTracks[i].mode === 'hidden' || player.textTracks[i].mode === 'showing') {
                    activeTrack = player.textTracks[i];
                    // Ensure the browser doesn't draw it natively while we map it
                    if (player.textTracks[i].mode === 'showing') player.textTracks[i].mode = 'hidden';
                    break;
                }
            }
        }

        let newText = '';
        if (activeTrack && activeTrack.activeCues && activeTrack.activeCues.length > 0) {
            for(let i = 0; i < activeTrack.activeCues.length; i++) {
                newText += activeTrack.activeCues[i].text.replace(/\n/g, '<br>') + (i < activeTrack.activeCues.length - 1 ? '<br>' : '');
            }
        }

        if (newText !== currentSubtitleText) {
            currentSubtitleText = newText;
            customSubtitles.innerHTML = newText;
        }
    });

    player.addEventListener('loadedmetadata', () => {
        timeline.max = player.duration;
        totalTimeDisplay.textContent = formatTime(player.duration);
        applyVideoTransforms(); // Reapply transformations to ensure constraints apply post-load
    });
    player.addEventListener('ended', playNext);

    // Timeline Drag
    timeline.addEventListener('mousedown', () => timeline.setAttribute('data-seeking', 'true'));
    timeline.addEventListener('mouseup', () => timeline.removeAttribute('data-seeking'));
    timeline.addEventListener('input', () => {
        player.currentTime = timeline.value;
        currentTimeDisplay.textContent = formatTime(timeline.value);
    });

    // Volume
    volumeSlider.addEventListener('input', () => {
        player.volume = volumeSlider.value;
        player.muted = false;
        updateVolumeUI();
        showOSD(`Volume: ${Math.round(player.volume * 100)}%`);
    });

    // Buttons
    btnPlay.onclick = togglePlay;
    btnStop.onclick = stop;
    btnNext.onclick = playNext;
    btnPrev.onclick = playPrev;
    btnMute.onclick = toggleMute;
    btnFullscreen.onclick = toggleFullscreen;
    btnTheater.onclick = toggleTheaterMode;
    
    // Video Area Double Click to Fullscreen
    videoContainer.ondblclick = toggleFullscreen;

    // Toggles
    btnPlaylist.onclick = () => {
        playlistSidebar.classList.toggle('collapsed');
        btnPlaylist.classList.toggle('active-state');
    };
    
    btnDarkMode.onclick = () => {
        const isDark = document.body.classList.toggle('dark-mode');
        btnDarkMode.classList.toggle('active-state');
        localStorage.setItem('vlc-web-theme', isDark ? 'dark' : 'light');
    };

    btnLoop.onclick = () => {
        isLooping = !isLooping;
        btnLoop.classList.toggle('active-state');
    };

    // --- PWA Installation Logic ---
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;
        // Update UI to notify the user they can add to home screen
        btnInstall.classList.remove('hidden');
    });

    btnInstall.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                showOSD("Installing Lume...");
            }
            deferredPrompt = null;
            btnInstall.classList.add('hidden');
        }
    });

    window.addEventListener('appinstalled', () => {
        btnInstall.classList.add('hidden');
        showOSD("Lume Installed!");
    });

    // Modal Events
    btnAbout.onclick = () => aboutModal.classList.remove('hidden');
    btnCloseAbout.onclick = () => aboutModal.classList.add('hidden');
    
    btnHelp.onclick = () => helpModal.classList.remove('hidden');
    btnCloseHelp.onclick = () => helpModal.classList.add('hidden');

    window.addEventListener('click', (e) => {
        if (e.target === aboutModal) aboutModal.classList.add('hidden');
        if (e.target === helpModal) helpModal.classList.add('hidden');
    });

    // Keyboard Shortcuts (VLC Mappings)
    window.addEventListener('keydown', (e) => {
        if (e.target.tagName.toLowerCase() === 'input' && e.target.type !== 'range') return;

        if (e.key === 'Escape') {
            aboutModal.classList.add('hidden');
            helpModal.classList.add('hidden');
            return;
        }

        if (!aboutModal.classList.contains('hidden') || !helpModal.classList.contains('hidden')) return;

        // Alt Shortcuts for Manual Zoom
        if (e.altKey) {
            if (e.key === '=' || e.key === '+') {
                e.preventDefault();
                customZoom = (customZoom === null ? 1 : customZoom) + 0.1;
                applyVideoTransforms('zoom');
                return;
            }
            if (e.key === '-') {
                e.preventDefault();
                customZoom = Math.max(0.1, (customZoom === null ? 1 : customZoom) - 0.1);
                applyVideoTransforms('zoom');
                return;
            }
        }

        switch(e.key.toLowerCase()) {
            case ' ':
                e.preventDefault(); // Prevent scrolling
                togglePlay();
                break;
            case 's':
                stop();
                break;
            case 'n':
                playNext();
                break;
            case 'p':
                playPrev();
                break;
            case 'f':
                e.preventDefault();
                toggleFullscreen();
                break;
            case 't':
                e.preventDefault();
                toggleTheaterMode();
                break;
            case 'z':
                e.preventDefault();
                toggleZoom();
                break;
            case 'a':
                e.preventDefault();
                toggleAspectRatio();
                break;
            case 'c':
                e.preventDefault();
                toggleCrop();
                break;
            case 'm':
                toggleMute();
                break;
            case ']':
                e.preventDefault();
                changePlaybackSpeed(0.25);
                break;
            case '[':
                e.preventDefault();
                changePlaybackSpeed(-0.25);
                break;
            case 'arrowright':
                e.preventDefault();
                if (e.ctrlKey) {
                    navigateSubtitles('next');
                } else {
                    player.currentTime = Math.min(player.currentTime + 10, player.duration);
                    showOSD(`+10s`);
                }
                break;
            case 'arrowleft':
                e.preventDefault();
                if (e.ctrlKey) {
                    navigateSubtitles('prev');
                } else {
                    player.currentTime = Math.max(player.currentTime - 10, 0);
                    showOSD(`-10s`);
                }
                break;
            case 'arrowup':
                e.preventDefault();
                player.volume = Math.min(player.volume + 0.05, 1);
                updateVolumeUI();
                showOSD(`Volume: ${Math.round(player.volume * 100)}%`);
                break;
            case 'arrowdown':
                e.preventDefault();
                player.volume = Math.max(player.volume - 0.05, 0);
                updateVolumeUI();
                showOSD(`Volume: ${Math.round(player.volume * 100)}%`);
                break;
        }
    });

    // Initialize UI and Theme
    const savedTheme = localStorage.getItem('vlc-web-theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        btnDarkMode.classList.add('active-state');
    }

    btnPlaylist.classList.add('active-state'); // Sidebar open by default
    updateVolumeUI();

</script>
</body>
</html>
