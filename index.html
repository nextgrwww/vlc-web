<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML5 Media Player</title>
    <style>
        /* CSS Reset & Font */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Lucida Grande", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #2c2c2c;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* GTK4 Window Layout Style */
        #app-window {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #ececec;
            /* GTK4 rounded corners when not fully maximized, but for web we fill screen. 
               Adding slight border radius if viewed in a smaller iframe */
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
        }

        /* Main Area (Video + Sidebar) */
        #main-area {
            display: flex;
            flex: 1;
            overflow: hidden;
            background-color: #000;
        }

        #video-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #000;
            overflow: hidden;
        }

        video {
            /* Sizing is controlled by JS for accurate AR/Crop constraints */
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            background-color: #000;
            outline: none;
            object-fit: contain;
            transition: max-width 0.1s, max-height 0.1s;
        }

        /* VLC Style Subtitles */
        ::cue {
            color: #ffffff;
            background-color: transparent;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 0px 2px 0 #000, 2px 0px 0 #000, 0px -2px 0 #000, -2px 0px 0 #000;
            font-family: Arial, sans-serif;
            font-size: 28px;
            font-weight: bold;
        }

        /* OSD (On Screen Display) */
        #osd-text {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            font-family: Arial, sans-serif;
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 50;
            pointer-events: none;
        }

        /* OS X Mavericks Styled Playlist Sidebar */
        #playlist-sidebar {
            width: 300px;
            background-color: #f1f5f8;
            border-left: 1px solid #b3b3b3;
            display: flex;
            flex-direction: column;
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #playlist-sidebar.collapsed {
            margin-right: -300px;
        }

        .playlist-header {
            background-image: linear-gradient(to bottom, #fdfdfd 0%, #e3e3e3 100%);
            border-bottom: 1px solid #a6a6a6;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            box-shadow: 0 1px 0 rgba(255,255,255,0.5) inset;
        }

        /* Mavericks Buttons */
        .mac-btn {
            background-image: linear-gradient(to bottom, #fdfdfd 0%, #e3e3e3 100%);
            border: 1px solid #a6a6a6;
            border-bottom-color: #979797;
            border-radius: 4px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset, 0 1px 1px rgba(0,0,0,0.05);
            color: #333;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px;
            font-size: 13px;
        }

        .mac-btn:active {
            background-image: linear-gradient(to bottom, #d0d0d0 0%, #e1e1e1 100%);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
        }

        .mac-btn svg {
            fill: #444;
            filter: drop-shadow(0 1px 0 rgba(255,255,255,0.8));
        }

        .mac-btn.active-state {
            background-image: linear-gradient(to bottom, #5cb4fc 0%, #0482fc 100%);
            border-color: #0364c6;
            color: white;
            text-shadow: 0 1px 0 rgba(0,0,0,0.4);
            box-shadow: 0 1px 1px rgba(255,255,255,0.3) inset;
        }

        .mac-btn.active-state svg {
            fill: white;
            filter: drop-shadow(0 -1px 0 rgba(0,0,0,0.4));
        }

        #playlist-items {
            list-style: none;
            overflow-y: auto;
            flex: 1;
            background-color: #ffffff;
        }

        /* Drag & Drop Highlight */
        #playlist-sidebar.dragover #playlist-items {
            background-color: #e6f3ff;
            border: 2px dashed #1e90ff;
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            font-size: 12px;
            color: #222;
            border-bottom: 1px solid #eaeaea;
            cursor: pointer;
        }

        .playlist-item-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 8px;
        }

        .playlist-item-controls {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .playlist-item:hover .playlist-item-controls {
            opacity: 1;
        }

        .item-btn {
            background: transparent;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3px;
            color: #555;
            transition: background 0.1s;
        }

        .item-btn:hover {
            background: #e0e0e0;
        }

        .item-btn svg {
            fill: currentColor;
        }

        .playlist-item:nth-child(even) {
            background-color: #f6f8fa;
        }

        .playlist-item.playing {
            background-color: #3875d7;
            color: white;
            font-weight: bold;
        }
        
        .playlist-item.playing .item-btn {
            color: white;
            border-color: #639bf0;
        }
        
        .playlist-item.playing .item-btn:hover {
            background: #255ebc;
        }

        /* Mavericks Scrollbar */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #f0f0f0; border-left: 1px solid #ddd; }
        ::-webkit-scrollbar-thumb {
            background-color: #c0c0c0;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
        }
        ::-webkit-scrollbar-thumb:hover { background-color: #a0a0a0; }

        /* Bottom Controls Area (VLC layout) */
        #controls-area {
            background-image: linear-gradient(to bottom, #ededed 0%, #d4d4d4 100%);
            border-top: 1px solid #999;
            display: flex;
            flex-direction: column;
            padding: 8px 12px 12px 12px;
            box-shadow: 0 1px 0 rgba(255,255,255,0.8) inset;
            z-index: 100;
        }

        /* Theater Mode & Fullscreen Overrides */
        #app-window.theater-mode #playlist-sidebar,
        #app-window:fullscreen #playlist-sidebar {
            display: none !important;
        }

        #app-window.theater-mode #controls-area,
        #app-window:fullscreen #controls-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-image: linear-gradient(to bottom, rgba(237,237,237,0.95) 0%, rgba(212,212,212,0.95) 100%);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        /* Auto-hide controls */
        #app-window.idle {
            cursor: none;
        }

        #app-window.idle #controls-area {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none;
        }

        /* Timeline Slider */
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .time-display {
            font-size: 11px;
            color: #555;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            font-variant-numeric: tabular-nums;
            width: 40px;
            text-align: center;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
        }
        
        input[type=range]:focus { outline: none; }

        /* Mavericks Slider Track */
        input[type=range]::-webkit-slider-runnable-track {
            height: 6px;
            background: #b8b8b8;
            border-radius: 3px;
            border: 1px solid #999;
            box-shadow: 0 1px 1px rgba(0,0,0,0.2) inset, 0 1px 0 rgba(255,255,255,0.8);
        }

        /* Mavericks Slider Thumb */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background-image: linear-gradient(to bottom, #ffffff 0%, #d4d4d4 100%);
            border: 1px solid #888;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            margin-top: -6px;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-group {
            display: flex;
        }
        
        .btn-group .mac-btn {
            border-radius: 0;
            border-right: none;
        }
        
        .btn-group .mac-btn:first-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
        }
        
        .btn-group .mac-btn:last-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            border-right: 1px solid #a6a6a6;
        }

        #now-playing-text {
            font-size: 12px;
            color: #444;
            text-shadow: 0 1px 0 rgba(255,255,255,0.8);
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        #volume-slider {
            width: 80px;
        }

        .hidden { display: none !important; }

        /* Dark Mode Overrides */
        body.dark-mode #app-window { background-color: #1e1e1e; }
        body.dark-mode #playlist-sidebar { background-color: #2c2c2c; border-left-color: #000; }
        body.dark-mode .playlist-header { 
            background-image: linear-gradient(to bottom, #4a4a4a 0%, #2b2b2b 100%);
            border-bottom-color: #000;
            color: #ddd;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.8);
            box-shadow: 0 1px 0 rgba(255,255,255,0.1) inset;
        }
        body.dark-mode .mac-btn {
            background-image: linear-gradient(to bottom, #555 0%, #333 100%);
            border-color: #111;
            box-shadow: 0 1px 0 rgba(255,255,255,0.1) inset, 0 1px 1px rgba(0,0,0,0.3);
            color: #eee;
        }
        body.dark-mode .mac-btn:active {
            background-image: linear-gradient(to bottom, #222 0%, #333 100%);
        }
        body.dark-mode .mac-btn svg {
            fill: #eee;
            filter: drop-shadow(0 -1px 0 rgba(0,0,0,0.8));
        }
        body.dark-mode .mac-btn.active-state {
            background-image: linear-gradient(to bottom, #1a5c9a 0%, #033a76 100%);
            border-color: #01162d;
            color: white;
            text-shadow: 0 1px 0 rgba(0,0,0,0.4);
            box-shadow: 0 1px 1px rgba(0,0,0,0.3) inset;
        }
        body.dark-mode .mac-btn.active-state svg {
            fill: white;
            filter: drop-shadow(0 -1px 0 rgba(0,0,0,0.4));
        }
        body.dark-mode #playlist-items { background-color: #1e1e1e; }
        body.dark-mode .playlist-item { color: #ccc; border-bottom-color: #333; }
        body.dark-mode .playlist-item:nth-child(even) { background-color: #252525; }
        body.dark-mode .playlist-item.playing { background-color: #1a5c9a; color: white; }
        
        body.dark-mode .item-btn { border-color: #555; color: #ccc; }
        body.dark-mode .item-btn:hover { background: #444; }
        
        body.dark-mode #controls-area {
            background-image: linear-gradient(to bottom, #444 0%, #222 100%);
            border-top-color: #000;
            box-shadow: 0 1px 0 rgba(255,255,255,0.1) inset;
        }
        body.dark-mode #app-window.theater-mode #controls-area,
        body.dark-mode #app-window:fullscreen #controls-area {
            background-image: linear-gradient(to bottom, rgba(68,68,68,0.95) 0%, rgba(34,34,34,0.95) 100%);
        }
        body.dark-mode .time-display { color: #bbb; text-shadow: 0 -1px 0 rgba(0,0,0,0.8); }
        body.dark-mode #now-playing-text { color: #ddd; text-shadow: 0 -1px 0 rgba(0,0,0,0.8); }
        body.dark-mode input[type=range]::-webkit-slider-runnable-track {
            background: #333;
            border-color: #111;
            box-shadow: 0 1px 1px rgba(0,0,0,0.5) inset, 0 1px 0 rgba(255,255,255,0.1);
        }
        body.dark-mode input[type=range]::-webkit-slider-thumb {
            background-image: linear-gradient(to bottom, #666 0%, #333 100%);
            border-color: #111;
        }
    </style>
</head>
<body>

<div id="app-window">
    <div id="main-area">
        <div id="video-container" title="Double click to toggle fullscreen">
            <video id="player" playsinline></video>
            <div id="osd-text"></div>
        </div>
        
        <div id="playlist-sidebar">
            <div class="playlist-header">
                <span>Playlist</span>
                <button class="mac-btn" id="add-media-btn" title="Add Media">
                    <svg width="12" height="12" viewBox="0 0 16 16"><path d="M7 7V2h2v5h5v2H9v5H7V9H2V7h5z"/></svg>
                </button>
                <input type="file" id="file-input" multiple accept="audio/*,video/*" class="hidden">
            </div>
            <ul id="playlist-items">
                <li style="padding: 20px; text-align: center; color: #888; font-style: italic;">
                    Drag & Drop media files here or click '+' to add.
                </li>
            </ul>
        </div>
    </div>

    <div id="controls-area">
        <div class="slider-container">
            <span class="time-display" id="current-time">00:00</span>
            <input type="range" id="timeline" value="0" min="0" step="0.1">
            <span class="time-display" id="total-time">00:00</span>
        </div>
        
        <div class="controls-row">
            <!-- Left Controls: Playback & View -->
            <div class="control-group">
                <div class="btn-group">
                    <button class="mac-btn" id="btn-play" title="Play/Pause (Space)">
                        <svg width="14" height="14" viewBox="0 0 16 16" id="icon-play"><path d="M4 2l10 6-10 6V2z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-prev" title="Previous (P)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M4 2v12h2V9l7 5V2l-7 5V2H4z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-stop" title="Stop (S)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M3 3h10v10H3V3z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-next" title="Next (N)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M12 2v12h-2V9l-7 5V2l7 5V2h2z"/></svg>
                    </button>
                </div>
                
                <div class="btn-group" style="margin-left: 8px;">
                    <button class="mac-btn" id="btn-theater" title="Theater Mode (T)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M1 3h14v10H1V3zm2 2v6h10V5H3z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-fullscreen" title="Fullscreen (F)">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M2 2v4h2V4h2V2H2zm10 0v2h2v2h2V2h-4zM2 14h4v-2H4v-2H2v4zm10 0h4v-4h-2v2h-2v2z"/></svg>
                    </button>
                </div>
            </div>

            <!-- Center Controls: Now Playing -->
            <div class="control-group" style="flex: 1; justify-content: center;">
                <div id="now-playing-text">VLC Web Player</div>
            </div>

            <!-- Right Controls: Playlist, Subtitles, Loop, Vol -->
            <div class="control-group">
                <button class="mac-btn" id="btn-dark-mode" title="Toggle Dark Mode" style="margin-right: 8px;">
                    <svg width="14" height="14" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>
                </button>
                
                <input type="file" id="subtitle-input" accept=".srt,.vtt" class="hidden">
                <div class="btn-group">
                    <button class="mac-btn" id="btn-subtitle" title="Load Subtitle File">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M2 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H2zm2.5 4.5H3v1h1.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H2a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5h2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5zm5 0H8v1h1.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5H7a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5h2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-playlist" title="Toggle Playlist">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M2 4h12v2H2V4zm0 4h12v2H2V8zm0 4h8v2H2v-2z"/></svg>
                    </button>
                    <button class="mac-btn" id="btn-loop" title="Loop">
                        <svg width="14" height="14" viewBox="0 0 16 16"><path d="M13 4v3h-2V5H5v2L2 4.5 5 2v2h8zM3 12v-3h2v2h8v-2l3 2.5-3 2.5v-2H3z"/></svg>
                    </button>
                </div>
                
                <button class="mac-btn" id="btn-mute" title="Mute (M)" style="margin-left: 8px;">
                    <svg width="14" height="14" viewBox="0 0 16 16" id="icon-vol"><path d="M2 6v4h3l4 4V2L5 6H2zm10-1.5v7c1.3-.7 2-2 2-3.5s-.7-2.8-2-3.5z"/></svg>
                </button>
                <input type="range" id="volume-slider" value="1" min="0" max="1" step="0.05" title="Volume (Up/Down)">
            </div>
        </div>
    </div>
</div>

<script>
    // --- State ---
    let playlist = []; // Array of { file: File, objectUrl: String|null, subtitleUrl: String|null }
    let currentIndex = -1;
    let isLooping = false;
    let idleTimer;
    let osdTimer;

    // Aspect Ratios & Crop Configuration
    const aspectRatios = ['Default', '16:9', '4:3', '1:1', '16:10', '2.21:1', '2.35:1', '2.39:1', '5:4'];
    let currentArIndex = 0;
    let currentCropIndex = 0;

    // --- DOM Elements ---
    const appWindow = document.getElementById('app-window');
    const player = document.getElementById('player');
    const videoContainer = document.getElementById('video-container');
    const controlsArea = document.getElementById('controls-area');
    const osdText = document.getElementById('osd-text');
    const fileInput = document.getElementById('file-input');
    const subtitleInput = document.getElementById('subtitle-input');
    const playlistItemsContainer = document.getElementById('playlist-items');
    const playlistSidebar = document.getElementById('playlist-sidebar');
    const timeline = document.getElementById('timeline');
    const volumeSlider = document.getElementById('volume-slider');
    const currentTimeDisplay = document.getElementById('current-time');
    const totalTimeDisplay = document.getElementById('total-time');
    const nowPlayingText = document.getElementById('now-playing-text');
    
    // Buttons
    const btnPlay = document.getElementById('btn-play');
    const btnPrev = document.getElementById('btn-prev');
    const btnStop = document.getElementById('btn-stop');
    const btnNext = document.getElementById('btn-next');
    const btnFullscreen = document.getElementById('btn-fullscreen');
    const btnTheater = document.getElementById('btn-theater');
    const btnPlaylist = document.getElementById('btn-playlist');
    const btnSubtitle = document.getElementById('btn-subtitle');
    const btnDarkMode = document.getElementById('btn-dark-mode');
    const btnLoop = document.getElementById('btn-loop');
    const btnMute = document.getElementById('btn-mute');
    const btnAddMedia = document.getElementById('add-media-btn');

    // SVGs for toggles and icons
    const iconPlay = `<path d="M4 2l10 6-10 6V2z"/>`;
    const iconPause = `<path d="M4 2h3v12H4V2zm5 0h3v12H9V2z"/>`;
    const iconVolOn = `<path d="M2 6v4h3l4 4V2L5 6H2zm10-1.5v7c1.3-.7 2-2 2-3.5s-.7-2.8-2-3.5z"/>`;
    const iconVolOff = `<path d="M2 6v4h3l4 4V2L5 6H2zm9 0l3 3m0-3l-3 3"/>`;
    const iconUp = `<svg width="10" height="10" viewBox="0 0 16 16"><path d="M8 2l-6 6h4v6h4V8h4z"/></svg>`;
    const iconDown = `<svg width="10" height="10" viewBox="0 0 16 16"><path d="M8 14l6-6h-4V2H6v6H2z"/></svg>`;
    const iconRemove = `<svg width="10" height="10" viewBox="0 0 16 16"><path d="M14 3.4L12.6 2 8 6.6 3.4 2 2 3.4 6.6 8 2 12.6 3.4 14 8 9.4 12.6 14 14 12.6 9.4 8z"/></svg>`;

    // --- Core Functions ---

    function formatTime(seconds) {
        if (isNaN(seconds)) return "00:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function showOSD(text) {
        osdText.textContent = text;
        osdText.style.opacity = 1;
        clearTimeout(osdTimer);
        osdTimer = setTimeout(() => osdText.style.opacity = 0, 2000);
    }

    // --- Playlist Management ---

    function updatePlaylistUI() {
        if (playlist.length === 0) {
            playlistItemsContainer.innerHTML = '<li style="padding: 20px; text-align: center; color: #888; font-style: italic;">Drag & Drop media files here or click \'+\' to add.</li>';
            return;
        }

        playlistItemsContainer.innerHTML = '';
        playlist.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = `playlist-item ${index === currentIndex ? 'playing' : ''}`;
            li.ondblclick = () => playItem(index);

            const titleSpan = document.createElement('div');
            titleSpan.className = 'playlist-item-title';
            titleSpan.textContent = item.file.name;
            titleSpan.title = item.file.name;

            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'playlist-item-controls';

            const btnUp = document.createElement('button');
            btnUp.className = 'item-btn';
            btnUp.title = "Move Up";
            btnUp.innerHTML = iconUp;
            btnUp.onclick = (e) => { e.stopPropagation(); moveItem(index, -1); };

            const btnDown = document.createElement('button');
            btnDown.className = 'item-btn';
            btnDown.title = "Move Down";
            btnDown.innerHTML = iconDown;
            btnDown.onclick = (e) => { e.stopPropagation(); moveItem(index, 1); };

            const btnRemove = document.createElement('button');
            btnRemove.className = 'item-btn';
            btnRemove.title = "Remove";
            btnRemove.innerHTML = iconRemove;
            btnRemove.onclick = (e) => { e.stopPropagation(); removeItem(index); };

            controlsDiv.append(btnUp, btnDown, btnRemove);
            li.append(titleSpan, controlsDiv);
            playlistItemsContainer.appendChild(li);
        });
    }

    function loadFiles(files) {
        for (let i = 0; i < files.length; i++) {
            if (files[i].type.startsWith('video/') || files[i].type.startsWith('audio/')) {
                playlist.push({
                    file: files[i],
                    objectUrl: null,
                    subtitleUrl: null
                });
            }
        }
        updatePlaylistUI();
        if (currentIndex === -1 && playlist.length > 0) {
            playItem(0);
        }
    }

    function moveItem(index, direction) {
        if (direction === -1 && index === 0) return;
        if (direction === 1 && index === playlist.length - 1) return;

        const targetIndex = index + direction;
        
        // Swap array elements
        const temp = playlist[index];
        playlist[index] = playlist[targetIndex];
        playlist[targetIndex] = temp;

        // Keep currentIndex tracking the actively playing item
        if (currentIndex === index) {
            currentIndex = targetIndex;
        } else if (currentIndex === targetIndex) {
            currentIndex = index;
        }

        updatePlaylistUI();
    }

    function removeItem(index) {
        const item = playlist[index];
        
        // Memory cleanup
        if (item.objectUrl) URL.revokeObjectURL(item.objectUrl);
        if (item.subtitleUrl) URL.revokeObjectURL(item.subtitleUrl);

        playlist.splice(index, 1);

        if (playlist.length === 0) {
            currentIndex = -1;
            player.src = "";
            let oldTrack = player.querySelector('track');
            if (oldTrack) oldTrack.remove();
            nowPlayingText.textContent = "VLC Web Player";
            stop();
        } else if (currentIndex === index) {
            // We removed the item currently playing
            currentIndex = -1; 
            let nextToPlay = index >= playlist.length ? playlist.length - 1 : index;
            playItem(nextToPlay);
        } else if (currentIndex > index) {
            // Shift index back to maintain correct tracking if an earlier item is removed
            currentIndex--;
        }

        updatePlaylistUI();
    }

    function playItem(index) {
        if (index < 0 || index >= playlist.length) return;
        
        const item = playlist[index];

        if (!item.objectUrl) {
            item.objectUrl = URL.createObjectURL(item.file);
        }
        player.src = item.objectUrl;

        // Handle item-specific subtitles
        let oldTrack = player.querySelector('track');
        if (oldTrack) oldTrack.remove();

        if (item.subtitleUrl) {
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = 'Custom Subtitles';
            track.srclang = 'en';
            track.src = item.subtitleUrl;
            track.default = true;
            player.appendChild(track);

            if (player.textTracks && player.textTracks.length > 0) {
                player.textTracks[0].mode = 'showing';
            }
        }

        currentIndex = index;
        nowPlayingText.textContent = item.file.name;
        updatePlaylistUI();
        
        // Reset crop and aspect ratio for new item
        currentArIndex = 0;
        currentCropIndex = 0;
        applyVideoTransforms('default', 0);

        player.play().catch(e => console.log("Playback prevented:", e));
    }

    function togglePlay() {
        if (playlist.length === 0) return;
        if (player.paused) {
            player.play();
            showOSD("Play");
        } else {
            player.pause();
            showOSD("Pause");
        }
    }

    function stop() {
        player.pause();
        player.currentTime = 0;
        btnPlay.querySelector('svg').innerHTML = iconPlay;
        showOSD("Stopped");
    }

    function playNext() {
        if (playlist.length === 0) return;
        let nextIdx = currentIndex + 1;
        if (nextIdx >= playlist.length) {
            nextIdx = isLooping ? 0 : playlist.length - 1;
            if (!isLooping) { stop(); return; }
        }
        playItem(nextIdx);
    }

    function playPrev() {
        if (playlist.length === 0) return;
        let prevIdx = currentIndex - 1;
        if (prevIdx < 0) prevIdx = isLooping ? playlist.length - 1 : 0;
        playItem(prevIdx);
    }

    function toggleMute() {
        player.muted = !player.muted;
        updateVolumeUI();
        showOSD(player.muted ? "Muted" : "Unmuted");
    }

    function updateVolumeUI() {
        if (player.muted || player.volume === 0) {
            btnMute.querySelector('svg').innerHTML = iconVolOff;
        } else {
            btnMute.querySelector('svg').innerHTML = iconVolOn;
        }
        volumeSlider.value = player.muted ? 0 : player.volume;
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            appWindow.requestFullscreen().catch(err => console.log(err));
        } else {
            document.exitFullscreen();
        }
    }

    function toggleTheaterMode() {
        if (document.fullscreenElement) return; // Ignore if already fullscreen
        appWindow.classList.toggle('theater-mode');
        btnTheater.classList.toggle('active-state');
        showOSD(appWindow.classList.contains('theater-mode') ? "Theater Mode On" : "Theater Mode Off");
    }

    // --- Aspect Ratio & Crop Engine ---
    
    function applyVideoTransforms(mode, ratioIndex) {
        const ar = aspectRatios[ratioIndex];
        
        if (ar === 'Default') {
            player.style.maxWidth = '100%';
            player.style.maxHeight = '100%';
            player.style.objectFit = 'contain';
            if (mode !== 'default') showOSD(mode === 'aspect' ? 'Aspect Ratio: Default' : 'Crop: Default');
            return;
        }

        const [w, h] = ar.split(':');
        // By setting the max bounds to exactly the ratio matching the window, and width/height to 100%,
        // we create a perfectly letterboxed box for the video to either fill (stretch) or cover (crop).
        player.style.maxWidth = `calc(100vh * (${w} / ${h}))`;
        player.style.maxHeight = `calc(100vw * (${h} / ${w}))`;
        
        if (mode === 'aspect') {
            player.style.objectFit = 'fill'; // Stretch internal video to the new bounds
            showOSD(`Aspect Ratio: ${ar}`);
        } else if (mode === 'crop') {
            player.style.objectFit = 'cover'; // Zoom internal video to fill bounds (cropping overflow)
            showOSD(`Crop: ${ar}`);
        }
    }

    function toggleAspectRatio() {
        currentArIndex = (currentArIndex + 1) % aspectRatios.length;
        currentCropIndex = 0; // Reset crop when changing AR
        applyVideoTransforms('aspect', currentArIndex);
    }

    function toggleCrop() {
        currentCropIndex = (currentCropIndex + 1) % aspectRatios.length;
        currentArIndex = 0; // Reset AR when changing Crop
        applyVideoTransforms('crop', currentCropIndex);
    }

    // --- Subtitles Engine ---
    
    function srtToVtt(srtContent) {
        let vtt = 'WEBVTT\n\n';
        // Replace SRT comma milliseconds with VTT dot milliseconds
        vtt += srtContent.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
        return vtt;
    }

    subtitleInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file || currentIndex === -1) {
            if (currentIndex === -1) showOSD("Load a media file first");
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            let content = e.target.result;
            
            if (file.name.toLowerCase().endsWith('.srt')) {
                content = srtToVtt(content);
            }

            const item = playlist[currentIndex];

            if (item.subtitleUrl) {
                URL.revokeObjectURL(item.subtitleUrl);
            }

            const blob = new Blob([content], { type: 'text/vtt' });
            item.subtitleUrl = URL.createObjectURL(blob);

            // Apply directly since this is the currently playing item
            let oldTrack = player.querySelector('track');
            if (oldTrack) oldTrack.remove();

            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.label = 'Custom Subtitles';
            track.srclang = 'en';
            track.src = item.subtitleUrl;
            track.default = true;
            player.appendChild(track);

            if (player.textTracks && player.textTracks.length > 0) {
                player.textTracks[0].mode = 'showing';
            }

            showOSD("Subtitle Loaded");
            subtitleInput.value = '';
        };
        reader.readAsText(file);
    });

    function navigateSubtitles(direction) {
        const tracks = player.textTracks;
        if (!tracks || tracks.length === 0) return;
        
        let track = null;
        for (let i = 0; i < tracks.length; i++) {
            if (tracks[i].mode === 'showing') {
                track = tracks[i];
                break;
            }
        }

        if (!track || !track.cues || track.cues.length === 0) {
            showOSD("No Subtitles Loaded");
            return;
        }

        const currentTime = player.currentTime;
        let targetTime = -1;

        if (direction === 'next') {
            for (let i = 0; i < track.cues.length; i++) {
                if (track.cues[i].startTime > currentTime + 0.1) {
                    targetTime = track.cues[i].startTime;
                    break;
                }
            }
        } else if (direction === 'prev') {
            for (let i = track.cues.length - 1; i >= 0; i--) {
                if (track.cues[i].startTime < currentTime - 0.5) { // Small buffer for double-tapping prev
                    targetTime = track.cues[i].startTime;
                    break;
                }
            }
        }

        if (targetTime !== -1) {
            player.currentTime = targetTime;
            showOSD(direction === 'next' ? 'Next Subtitle' : 'Prev Subtitle');
        }
    }

    function changePlaybackSpeed(delta) {
        player.playbackRate = Math.max(0.25, Math.min(4.0, player.playbackRate + delta));
        showOSD(`Speed: ${player.playbackRate.toFixed(2)}x`);
    }

    // --- Idle Cursor / Controls Management ---
    function resetIdleTimer() {
        appWindow.classList.remove('idle');
        clearTimeout(idleTimer);

        // Only auto-hide controls in theater or fullscreen mode
        if (document.fullscreenElement || appWindow.classList.contains('theater-mode')) {
            idleTimer = setTimeout(() => {
                appWindow.classList.add('idle');
            }, 2000); // 2 seconds idle timeout
        }
    }

    // Prevent hiding while hovering directly over controls
    controlsArea.addEventListener('mouseenter', () => {
        clearTimeout(idleTimer);
        appWindow.classList.remove('idle');
    });
    
    controlsArea.addEventListener('mouseleave', resetIdleTimer);
    window.addEventListener('mousemove', resetIdleTimer);

    // Fullscreen change handler
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            btnFullscreen.classList.add('active-state');
            appWindow.classList.remove('theater-mode'); // Disable theater mode if forcing fullscreen
            btnTheater.classList.remove('active-state');
            
            // Recalculate aspect bounds if fullscreen changes dimensions
            if (currentArIndex > 0) applyVideoTransforms('aspect', currentArIndex);
            if (currentCropIndex > 0) applyVideoTransforms('crop', currentCropIndex);
            
            resetIdleTimer();
        } else {
            btnFullscreen.classList.remove('active-state');
            clearTimeout(idleTimer);
            appWindow.classList.remove('idle');
            
            if (currentArIndex > 0) applyVideoTransforms('aspect', currentArIndex);
            if (currentCropIndex > 0) applyVideoTransforms('crop', currentCropIndex);
        }
    });

    // Window resize handler for bounds recalculation
    window.addEventListener('resize', () => {
        if (currentArIndex > 0) applyVideoTransforms('aspect', currentArIndex);
        if (currentCropIndex > 0) applyVideoTransforms('crop', currentCropIndex);
    });

    // --- Event Listeners ---

    // File Inputs
    btnAddMedia.onclick = () => fileInput.click();
    fileInput.onchange = (e) => loadFiles(e.target.files);
    btnSubtitle.onclick = () => subtitleInput.click();

    // Drag and Drop
    playlistSidebar.addEventListener('dragover', (e) => {
        e.preventDefault();
        playlistSidebar.classList.add('dragover');
    });
    playlistSidebar.addEventListener('dragleave', () => {
        playlistSidebar.classList.remove('dragover');
    });
    playlistSidebar.addEventListener('drop', (e) => {
        e.preventDefault();
        playlistSidebar.classList.remove('dragover');
        if (e.dataTransfer.files.length > 0) {
            loadFiles(e.dataTransfer.files);
        }
    });

    // Player events
    player.addEventListener('play', () => btnPlay.querySelector('svg').innerHTML = iconPause);
    player.addEventListener('pause', () => btnPlay.querySelector('svg').innerHTML = iconPlay);
    player.addEventListener('timeupdate', () => {
        if (!timeline.getAttribute('data-seeking')) {
            timeline.value = player.currentTime;
        }
        currentTimeDisplay.textContent = formatTime(player.currentTime);
    });
    player.addEventListener('loadedmetadata', () => {
        timeline.max = player.duration;
        totalTimeDisplay.textContent = formatTime(player.duration);
    });
    player.addEventListener('ended', playNext);

    // Timeline Drag
    timeline.addEventListener('mousedown', () => timeline.setAttribute('data-seeking', 'true'));
    timeline.addEventListener('mouseup', () => timeline.removeAttribute('data-seeking'));
    timeline.addEventListener('input', () => {
        player.currentTime = timeline.value;
        currentTimeDisplay.textContent = formatTime(timeline.value);
    });

    // Volume
    volumeSlider.addEventListener('input', () => {
        player.volume = volumeSlider.value;
        player.muted = false;
        updateVolumeUI();
        showOSD(`Volume: ${Math.round(player.volume * 100)}%`);
    });

    // Buttons
    btnPlay.onclick = togglePlay;
    btnStop.onclick = stop;
    btnNext.onclick = playNext;
    btnPrev.onclick = playPrev;
    btnMute.onclick = toggleMute;
    btnFullscreen.onclick = toggleFullscreen;
    btnTheater.onclick = toggleTheaterMode;
    
    // Video Area Double Click to Fullscreen
    videoContainer.ondblclick = toggleFullscreen;

    // Toggles
    btnPlaylist.onclick = () => {
        playlistSidebar.classList.toggle('collapsed');
        btnPlaylist.classList.toggle('active-state');
    };
    
    btnDarkMode.onclick = () => {
        const isDark = document.body.classList.toggle('dark-mode');
        btnDarkMode.classList.toggle('active-state');
        localStorage.setItem('vlc-web-theme', isDark ? 'dark' : 'light');
    };

    btnLoop.onclick = () => {
        isLooping = !isLooping;
        btnLoop.classList.toggle('active-state');
    };

    // Keyboard Shortcuts (VLC Mappings)
    window.addEventListener('keydown', (e) => {
        // Prevent shortcuts if interacting with input fields
        if (e.target.tagName.toLowerCase() === 'input' && e.target.type !== 'range') return;

        switch(e.key.toLowerCase()) {
            case ' ':
                e.preventDefault(); // Prevent scrolling
                togglePlay();
                break;
            case 's':
                stop();
                break;
            case 'n':
                playNext();
                break;
            case 'p':
                playPrev();
                break;
            case 'f':
                e.preventDefault();
                toggleFullscreen();
                break;
            case 't':
                e.preventDefault();
                toggleTheaterMode();
                break;
            case 'a':
                e.preventDefault();
                toggleAspectRatio();
                break;
            case 'c':
                e.preventDefault();
                toggleCrop();
                break;
            case 'm':
                toggleMute();
                break;
            case ']':
                e.preventDefault();
                changePlaybackSpeed(0.25);
                break;
            case '[':
                e.preventDefault();
                changePlaybackSpeed(-0.25);
                break;
            case 'arrowright':
                e.preventDefault();
                if (e.ctrlKey) {
                    navigateSubtitles('next');
                } else {
                    player.currentTime = Math.min(player.currentTime + 10, player.duration);
                    showOSD(`+10s`);
                }
                break;
            case 'arrowleft':
                e.preventDefault();
                if (e.ctrlKey) {
                    navigateSubtitles('prev');
                } else {
                    player.currentTime = Math.max(player.currentTime - 10, 0);
                    showOSD(`-10s`);
                }
                break;
            case 'arrowup':
                e.preventDefault();
                player.volume = Math.min(player.volume + 0.05, 1);
                updateVolumeUI();
                showOSD(`Volume: ${Math.round(player.volume * 100)}%`);
                break;
            case 'arrowdown':
                e.preventDefault();
                player.volume = Math.max(player.volume - 0.05, 0);
                updateVolumeUI();
                showOSD(`Volume: ${Math.round(player.volume * 100)}%`);
                break;
        }
    });

    // Initialize UI and Theme
    const savedTheme = localStorage.getItem('vlc-web-theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        btnDarkMode.classList.add('active-state');
    }

    btnPlaylist.classList.add('active-state'); // Sidebar open by default
    updateVolumeUI();

</script>
</body>
</html>
